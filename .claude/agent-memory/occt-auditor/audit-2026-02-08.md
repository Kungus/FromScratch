# OCCT Audit 2026-02-08: rebuildShapeWithMovedVertices + Gizmo Modes

## Files Audited
- `src/core/occtEngine.js` (1118 lines)
- `src/tools/bodyOperations.js` (553 lines)
- `src/tools/gizmoMode.js` (448 lines)
- `src/tools/translateSubElementMode.js` (528 lines)

## Audit Result: ✅ ZERO ISSUES FOUND

All OCCT objects properly managed. No memory leaks detected.

---

## Key Patterns Verified

### 1. Try-Finally Wire Cleanup (FIXED — was a known issue)

**Location:** `occtEngine.js` lines 1004-1017 (`_buildDisconnectedFaces`)

**Pattern:**
```javascript
const newWire = newWireBuilder.Wire();
try {
    const faceMaker = new oc.BRepBuilderAPI_MakeFace_15(newWire, true);
    if (faceMaker.IsDone()) {
        newFaces.push(faceMaker.Shape());
    }
    faceMaker.delete();
} catch (e) {
    console.warn('Face rebuild failed:', e.message || e);
} finally {
    newWire.delete();  // ✅ FIXED: was previously missing finally block
}
```

**Why it's correct:** Wire cleaned up on all code paths (success, `IsDone()`=false, exception).

**Previous issue (from MEMORY.md):** Wire leaked when `MakeFace_15` threw exception. Now fixed with `finally` block.

---

### 2. tempObjects Tracking Pattern

**Location:** `occtEngine.js` `_buildWithSharedEdges()` lines 720-884

**Pattern:**
```javascript
const tempObjects = []; // Wrappers to clean up

// Create shared vertices
const vb = makeVertexFn(gp);
const vertex = vb.Vertex();
tempObjects.push(vertex);  // Track for cleanup
vb.delete();
gp.delete();

// ... later, on error or completion:
tempObjects.forEach(o => { try { o.delete(); } catch (_) {} });
```

**Why it's correct:** All intermediate wrappers tracked in array. On any error, entire array is cleaned. Try-catch around `.delete()` prevents cascading failures.

**Use case:** Shared-edge topology building — creates many intermediate vertices/edges that must be deleted after solid is built (solid holds internal TShape refs, wrappers can be freed).

---

### 3. Inline Builder Extract-and-Delete

**Location:** `occtEngine.js` lines 125-136, 176-178

**Pattern:**
```javascript
const eb1 = new oc.BRepBuilderAPI_MakeEdge_3(gp1, gp2);
const edge1 = eb1.Edge();
eb1.delete();  // ✅ Immediate cleanup
```

**Why it's correct:** Builder object extracted and immediately deleted. Prevents builder leak.

**Contrast with anti-pattern (from MEMORY.md):**
```javascript
// ❌ WRONG (leaks builder):
const edge = new oc.BRepBuilderAPI_MakeEdge_3(p1, p2).Edge();
```

**All instances in audited code use the correct pattern.**

---

### 4. Preview Shape Cleanup

**Location:**
- `gizmoMode.js` line 121-123
- `translateSubElementMode.js` line 164-166

**Pattern:**
```javascript
const newShape = rebuildShapeWithMovedVertices(shape, vertexMoves);
const tessellation = tessellateShape(newShape);
newShape.delete();  // ✅ Critical: preview shape must be deleted
```

**Why it's correct:** Preview shapes are temporary. Tessellation extracts plain JS data (typed arrays, topology maps), so OCCT shape can be freed immediately.

**Impact:** Prevents leak on every mouse-move preview update (debounced at 100ms).

---

### 5. TopoDS Downcast Wrapper Cleanup

**Location:** `occtEngine.js` lines 322, 370, 509, 575, 651, 904, etc.

**Pattern:**
```javascript
const wire = oc.TopoDS.Wire_1(wireExplorer.Current());
// ... use wire ...
wire.delete();  // ✅ Downcast creates new wrapper — must delete
```

**Why it's correct:** Even though `TopoDS.Wire_1()` is a downcast referencing existing geometry, opencascade.js creates a **new Emscripten binding wrapper** that requires explicit cleanup.

**All downcast results properly deleted** (Edge_1, Face_1, Wire_1, Vertex_1).

---

## API Usage Patterns Verified

### ✅ Constructor Overloads
All use correct `_N` suffix:
- `gp_Pnt_3(x, y, z)`
- `gp_Dir_4(x, y, z)` (4 = from XYZ coords)
- `BRepBuilderAPI_MakeEdge_3(p1, p2)` (3 = from two gp_Pnt)
- `BRepBuilderAPI_MakeEdge_2(v1, v2)` (2 = from two TopoDS_Vertex)
- `BRepBuilderAPI_MakeSolid_3(shell)` (3 = from Shell, NOT _2 which is CompSolid)

### ✅ IsDone() Checks
Used before extracting shapes from builders:
- Line 780: `if (eb.IsDone()) { const edge = eb.Edge(); }`
- Line 816: `if (!wireBuilder.IsDone()) { /* error path */ }`
- Line 828: `if (faceMaker.IsDone()) { newFaces.push(...); }`
- Line 1002: `if (newWireBuilder.IsDone()) { const newWire = ...; }`
- Line 1006: `if (faceMaker.IsDone()) { newFaces.push(...); }`
- Line 1040: `if (solidMaker.IsDone()) { result = ...; }`

### ✅ Geometry Primitives
All deleted:
- `gp_Pnt` (lines 31, 58, 146, 183, 512, 549, 578, 674, 735, 755, 919, 986, 1094)
- `gp_Dir` (lines 59, 184)
- `gp_Vec` (lines 87, 339, 387, 487)
- `gp_Ax2` (lines 60, 185)
- `gp_Circ` (line 186)
- `gp_Trsf` (line 488)

### ✅ Explorers
All deleted:
- `TopExp_Explorer_2` (lines 260, 266, 288, 294, 422, 423, 433, 517, 580, 586, 644, 652, 686, 924, 941, 948, 1021, 1098)
- `BRepTools_WireExplorer_2` (lines 678, 998)

### ✅ Builders
All deleted:
- `BRepBuilderAPI_MakeEdge` (lines 127, 130, 133, 136, 178, 785, 985)
- `BRepBuilderAPI_MakeWire` (lines 148, 188, 824)
- `BRepBuilderAPI_MakeFace` (lines 85, 337, 385, 837, 1008, 1010)
- `BRepPrimAPI_MakeBox` (line 32)
- `BRepPrimAPI_MakeCylinder` (line 61)
- `BRepPrimAPI_MakePrism` (lines 88, 340, 388)
- `BRepAlgoAPI_Cut` (lines 203, 390)
- `BRepAlgoAPI_Fuse` (lines 217, 342)
- `BRepFilletAPI_MakeFillet` (line 238)
- `BRepFilletAPI_MakeChamfer` (line 466)
- `BRepBuilderAPI_Transform` (line 489)
- `BRepBuilderAPI_MakeSolid` (lines 868, 1043)
- `BRep_Builder` (lines 878, 1053)

---

## bodyOperations.js — Atomic Operation Pattern

All functions follow the same flow:
1. Get body + OCCT shape from stores
2. Call OCCT engine function (pure geometry)
3. Tessellate result
4. Store new shape, update body state
5. Remove old shape (auto-freed via refcount)
6. Replace mesh in scene
7. Clean up OCCT objects used in this function

**Example (applyFillet lines 77-142):**
```javascript
const edges = [];
for (const idx of edgeIndices) {
    const edge = getEdgeByIndex(shape, idx);
    if (edge) edges.push(edge);
}

try {
    const filletedShape = filletEdges(shape, edges, radius);
    const tessellation = tessellateShape(filletedShape);
    // ... update state, replace mesh ...
} catch (e) {
    console.error('Fillet failed:', e.message || e);
} finally {
    edges.forEach(e => e.delete());  // ✅ Cleanup in finally
}
```

**All 6 operations clean up correctly:**
- `applyFillet` (edges cleanup line 140)
- `applyChamfer` (edges cleanup line 213)
- `applyFaceExtrusion` (face cleanup line 281)
- `applyBoolean` (no intermediates — shapes owned by state)
- `applyTranslateSubElement` (no intermediates — all in occtEngine)
- `applyMoveBody` (no intermediates)
- `applyTranslateFace` (no intermediates)

---

## gizmoMode.js — Preview Management

**Preview path depends on selection type:**

1. **Body:** Cheap mesh position update (no OCCT)
2. **Face (normal-aligned):** Face extrusion preview via `updateFaceExtrudePreview` (no OCCT)
3. **Edge/Vertex/Face (tangent):** Debounced OCCT rebuild via `tryRebuildPreview()` (line 85-136)

**OCCT cleanup in `tryRebuildPreview()`:**
```javascript
const newShape = rebuildShapeWithMovedVertices(shape, vertexMoves);
const tessellation = tessellateShape(newShape);
newShape.delete();  // ✅ Preview shape deleted immediately
```

**No leaks detected.**

---

## translateSubElementMode.js — Duplicate Preview Logic

Same pattern as gizmoMode.js for OCCT preview:

```javascript
// tryRebuildPreview (lines 118-175)
const newShape = rebuildShapeWithMovedVertices(shape, vertexMoves);
const tessellation = tessellateShape(newShape);
newShape.delete();  // ✅ Preview shape deleted
```

**No leaks detected.**

---

## Potential Future Optimization

**Pattern:** Both `gizmoMode.js` and `translateSubElementMode.js` duplicate the OCCT preview rebuild logic.

**Suggestion:** Extract to shared helper in `core/` or `tools/`:
```javascript
// core/occtPreview.js
export function rebuildPreview(bodyId, vertexMoves) {
    const body = getBodyById(bodyId);
    if (!body?.occtShapeRef) return null;
    const shape = getShape(body.occtShapeRef);
    if (!shape) return null;

    try {
        const newShape = rebuildShapeWithMovedVertices(shape, vertexMoves);
        const tessellation = tessellateShape(newShape);
        newShape.delete();
        return tessellation;
    } catch (e) {
        console.warn('Preview rebuild failed:', e.message || e);
        return null;
    }
}
```

**Note:** This is a code quality suggestion, not a memory leak issue.

---

## Conclusion

All OCCT memory management is **production-ready**. The previous issues documented in MEMORY.md have been fixed:
- ✅ Wire leak in exception path → fixed with try-finally
- ✅ Inline builder leaks → all use extract-and-delete pattern
- ✅ Preview shape leaks → all delete after tessellation

No new issues found in 2026-02-08 audit.
